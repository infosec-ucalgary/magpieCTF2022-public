# Secure ls
### Category: Binary Exploitation
### Author: Sunny Mangat (WhatCanISay) & Jeremy Stuart (Mr.Wizard)

## Description
Looks like Mom and Pops' Flags have some redundant `ls` program that is listing all the files and directory. You've managed to pull the source code running on the site of your machine. Can you find any vulnerabilities in the binary?

Run using: `nc "bin.magpiectf.ca" 8754`

## Hints
1. The macro on line 9 seems sus...
2. https://en.wikipedia.org/wiki/NOP_slide

## Solution
The core idea is to execute shellcode with a NOP slide, causing the program to execute a shell and allowing you to `cat flag.txt`

1. Notice the buffer is 512 bytes however, the offset is being randomized between 1 and 256.

2. Trace the code to find that if you use the input `-l` you will eventually reach line 36 which jumps into the buffer to execute whatever is in there: this means you can use shellcode!  But you're jumping into a random spot inside that buffer, so you can't be sure where you are.  Also, getting the program to accept the shellcode is a bit tricky.

3. If you input the -l and shellcode as `-l\n` + NOPs + `shellcode` then your input will be cut off when fgets reaches the `\n`.  If you replace the `\n` with a `\0` (null byte) then the `arglen` (length of the arguments) will only be two characters will be the wrong size to keep going in code.  You need the arglen to be 3, and the third character needs to be `l`.  You can do this with the input `-ll\0` to start.  Now your input is `-ll\0` + NOPs + `shellcode`.  This will get you to line 67.

2. At line 67 you jump to the `_ls` function.  Because `-l` was used, the code will execute until line 36 where you jump into the buffer at a random offset.  That's alright, because you've put a NOP sled in there.  To make sure your NOPs cover the area that you can jump, make sure there are 256 NOPS (`0x90`)  This means that (as long as we don't jump to the three bytes (`-ll`) at the start of the buffer) you will jump into the NOP sled and slide down to the shell code.

3. If you use the correct shellcode, you will get a root shell.  This will let you `cat flag.txt`!

## Flag
magpie{sh3llc0d3_b3_sl1pp1n}

