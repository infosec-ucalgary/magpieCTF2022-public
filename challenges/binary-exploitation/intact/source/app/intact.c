#include <stdio.h>
#include <stdlib.h>
#include <string.h>

char flag[64];
char stored_canary[7] = "canary";

void win() {
	FILE * f = fopen("flag.txt", "r");
	if (f == NULL) { printf("Flag file missing\n"); exit(0); }
	fgets(flag, 64, f);
	printf("%s\n", flag);
}

char * rand_string(char *str, size_t size) {
    const char charset[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJK...";
    if (size) {
        --size;
        for (size_t n = 0; n < size; n++) {
            int key = rand() % (int) (sizeof charset - 1);
            str[n] = charset[key];
        }
        str[size] = '\0';
    }
    return str;
}

int verifyPassword() {

        char password[8];
	char stack_canary[7] = "canary";
        char inputpwd[8];
        int result;
        rand_string(password, sizeof(password));
        puts("Please enter your password:\n");
        gets(inputpwd);
	result = strncmp(password, inputpwd, 8);
	if (strncmp(stack_canary, stored_canary, sizeof(stored_canary)) != 0) {
		puts("Stack smashing detected. Aborting.\n");
		exit(1);
	}
        return 1;
}

int main(int argc, char ** argv) {
	
	setvbuf ( stdout, NULL , _IONBF , 0 );

	if (verifyPassword() == 0) {
		printf("Authentication confirmed. Welcome!\n");
	}

	else {
		printf("Incorrect password.  Login attempt reported to administrator.\n");

	}

}

const char *site = "http://omniflags.com";
