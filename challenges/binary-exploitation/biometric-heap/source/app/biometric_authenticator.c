#include <sys/types.h>
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <stdio.h>
#include <time.h>

struct auth {
	char userid[8];
	char setpwd[8];
	void (*bmts_auth)();
};

struct auth *auth_p;
char *service;

void employee_shell() { system("/bin/sh"); }

char * rand_string(char *str, size_t size) {
	srand((unsigned int)(time(NULL)));
	const char charset[] = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJK...";
	if (size) {
		--size;
		for (size_t n = 0; n < size; n++) {
			int key = rand() % (int) (sizeof charset - 1);
			str[n] = charset[key];
		}
		str[size] = '\0';
	}
	return str;
}

void biometrics_authenticator() {
	puts("Under development.\n");
	puts("Biometrics struct will be assigned a specialized biomtrics authentication function for each employee.\n");
	exit(1);
}

void help() {

	puts("\nAvailable commands:\n" 				\
	     "Exit - \"q\"\n" 					\
	     "Change user - \"reset\"\n" 			\
	     "Clear screen - \"clear\"\n"			\
	     "Bring up this menu - \"h\"\n" 			\
	     "Login as current user - \"login\"\n"		\
	     "Identify user - \"auth <user id>\"\n"		\
	     "Request service - \"service <service name>\"\n\n");
}

int main(int argc, char **argv) {

	setvbuf ( stdout, NULL , _IONBF , 0 );
	
	char line[128];
	char newpwd[8];
	rand_string(newpwd, sizeof(newpwd));

	puts("\nWelcome and congratulations on being hired!\n" \
	     "Your biometrics have just been submitted, and a new password has been assigned to you.\n" \
	     "Please contact your manager to obtain your password.\n\n");


	help();

	while(1) {

		if(fgets(line, sizeof(line), stdin) == NULL) break;

		if(strncmp(line, "auth", 4) == 0) {
			auth_p = malloc(sizeof(struct auth));
			memset(auth_p, 0, sizeof(struct auth));
			strcpy(auth_p->setpwd, newpwd);
			auth_p->bmts_auth = biometrics_authenticator;
			if(strlen(line + 5) < sizeof(auth_p->userid)) {
				strcpy(auth_p->userid, line + 5);
			}
		}

		if(strncmp(line, "login", 5) == 0) {

			while(1) {

				if (auth_p->userid == NULL) {
					puts("\nERROR: Please identify yourself first!");
					break;
				}

				printf("Please enter your password or \"q\" to quit: \n");
				fgets(line, sizeof(line), stdin);

				if (strncmp(line, "q", 1) == 0) { break; }

				else if (strcmp(line, auth_p->setpwd) == 0) {
					auth_p->bmts_auth();
				}

			}

		}
		if(strncmp(line, "service", 6) == 0) { service = strdup(line + 6); }
		if(strncmp(line, "q", 1) == 0) { puts("\nExiting\n"); break; }
		if(strncmp(line, "reset", 5) == 0) { free(auth_p); }
		if(strncmp(line, "clear", 5) == 0) { system("/bin/clear"); } 
		if(strncmp(line, "h", 1) == 0) { help(); } 
	}
}
